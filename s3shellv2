#!/bin/bash

# Specify your bucket name and prefix if needed
bucket_name="your-bucket-name"
prefix=""  # e.g., "your/prefix/" if needed

# Date range in Zulu time format
start_date="2023-12-01T00:00:00Z"
end_date="2023-12-31T23:59:59Z"

# Convert Zulu dates to epoch
start_epoch=$(date -d "$start_date" +%s)
end_epoch=$(date -d "$end_date" +%s)

# Function to list objects in S3 bucket
list_s3_objects() {
    local continuation_token=$1
    if [ -z "$continuation_token" ]; then
        aws s3api list-objects-v2 --bucket "$bucket_name" --prefix "$prefix"
    else
        aws s3api list-objects-v2 --bucket "$bucket_name" --prefix "$prefix" --continuation-token "$continuation_token"
    fi
}

# Initialize variables
filenames=()
continuation_token=""

# Collect all filenames
while : ; do
    if [ -z "$continuation_token" ]; then
        result=$(list_s3_objects)
    else
        result=$(list_s3_objects "$continuation_token")
    fi

    # Extract filenames and append to array
    filenames+=($(echo "$result" | grep -o '"Key": "[^"]*' | sed 's/"Key": "//'))

    # Check for continuation token
    continuation_token=$(echo "$result" | grep -o '"NextContinuationToken": "[^"]*' | sed 's/"NextContinuationToken": "//')
    if [ -z "$continuation_token" ]; then
        break
    fi
done

# Write filenames to CSV
echo "Filename" > filenames.csv
for filename in "${filenames[@]}"; do
    echo "$filename" >> filenames.csv
done

echo "Successfully written ${#filenames[@]} filenames to filenames.csv"

# Read filenames.csv and process each line
echo "Filename,StartEpoch,EndEpoch" > filtered_filenames.csv
while IFS=, read -r filename; do
    # Skip the header line
    if [[ "$filename" == "Filename" ]]; then
        continue
    fi
    
    # Extract start and end epoch from the filename
    start_epoch_from_filename=$(echo "$filename" | awk -F'_' '{print $(NF-2)}')
    end_epoch_from_filename=$(echo "$filename" | awk -F'_' '{print $(NF-1)}')

    # Check if the epochs fall within the specified date range
    if [[ "$start_epoch_from_filename" -ge "$start_epoch" && "$end_epoch_from_filename" -le "$end_epoch" ]]; then
        # Write to the new CSV file
        echo "$filename,$start_epoch_from_filename,$end_epoch_from_filename" >> filtered_filenames.csv
    fi
done < filenames.csv

echo "Filtered filenames written to filtered_filenames.csv"
